```{r, include = FALSE}
# snakemake <- readRDS(".movement_vs_rest.Rmd.RDS")
snakemake@source("R/rmd_setup.R")
library(data.table)
library(dplyr)
library(foreach)
library(ggplot2)
library(ggpubr)

config <- snakemake@config

samples <- fread(snakemake@input$samples) %>%
  .[ , Count := NULL ] %>%
  .[ , Region := gsub(Region, pattern = "_", replacement = " ") ] %>%
  .[ , Region := gsub(Region, pattern = "23", replacement = "2/3") ] %>%
  .[ , Layer := gsub(Layer, pattern = "23", replacement = "2/3") ]

movement <- foreach(file = snakemake@input$movement, .combine = rbind) %do% {
  sid <- gsub(file, pattern = ".*(W./C.*)/movement_episodes.csv", replacement = "\\1") %>% gsub(pattern = "/", replacement = "_")
  fread(file) %>%
    .[ , SID := sid ]
}

rest <- foreach(file = snakemake@input$rest, .combine = rbind) %do% {
  sid <- gsub(file, pattern = ".*(W./C.*)/rest_episodes.csv", replacement = "\\1") %>% gsub(pattern = "/", replacement = "_")
  fread(file) %>%
    .[ , SID := sid ]
}

ap <- foreach(file = snakemake@input$action_potentials, .combine = rbind) %do% {
  sid <- gsub(file, pattern = ".*(W./C.*)/action_potentials.csv", replacement = "\\1") %>% gsub(pattern = "/", replacement = "_")
  fread(file) %>%
    .[ , SID := sid ]
}

stopifnot(all(samples[ , SID ] %in% movement[ , unique(SID) ]))
stopifnot(all(movement[ , unique(SID) ] %in% samples[ , SID ]))

stopifnot(all(samples[ , SID ] %in% rest[ , unique(SID) ]))
stopifnot(all(rest[ , unique(SID) ] %in% samples[ , SID ]))

# The opposite is not always true as some samples do not have
# any action potentials
stopifnot(all(ap[ , unique(SID) ] %in% samples[ , SID ]))
```

---
date: <small>`r Sys.Date()`</small>
author: <small>`r config$report$author`</small>
title: `r config$report$title`
---

# Movement vs Rest {.tabset .tabset-pills}

## Episode counts {.unnumbered .unlisted}

```{r, include = TRUE, warning = FALSE, fig.height = 5.4}
counts <- rbind(
  movement[ , list(Count = .N, Episode = "Movement"), by = SID ],
  rest[ , list(Count = .N, Episode = "Rest"), by = SID ]
) %>% merge(samples, by = "SID")

stopifnot(all(counts[ Episode == "Movement", SID ] %in% samples[ , SID ]))
stopifnot(all(counts[ Episode == "Rest", SID ] %in% samples[ , SID ]))

p1 <- counts %>%
  ggpaired(x = "Episode", y = "Count", id = "SID",
           line.color = "gray", line.size = 0.2, point.size = 0, color = "white") +
  geom_boxplot(outlier.alpha = 0, fill = NA, linewidth = 0.25) +
  geom_point(alpha = 0.5, size = 1) +
  stat_compare_means(comparisons = list(c("Movement", "Rest")), paired = TRUE, size = 2.5) +
  xlab("") +
  ylab("Number of episodes") +
  theme_light(base_size = 8) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)))

p2 <- counts %>%
  ggpaired(x = "Episode", y = "Count", id = "SID",
           line.color = "gray", line.size = 0.2, point.size = 0, color = "white") +
  facet_grid(~Region) +
  geom_boxplot(outlier.alpha = 0, fill = NA, linewidth = 0.25) +
  geom_point(alpha = 0.5, size = 1) +
  stat_compare_means(comparisons = list(c("Movement", "Rest")), paired = TRUE, size = 2.5) +
  theme_light(base_size = 8) +
  xlab("") +
  ylab("Number of episodes") +
  theme(strip.background = element_rect(fill = "white")) +
  theme(strip.text = element_text(colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)))

p3 <- counts %>%
  ggpaired(x = "Episode", y = "Count", id = "SID",
           line.color = "gray", line.size = 0.2, point.size = 0, color = "white") +
  facet_grid(~Layer) +
  geom_boxplot(outlier.alpha = 0, fill = NA, linewidth = 0.25) +
  geom_point(alpha = 0.5, size = 1) +
  stat_compare_means(comparisons = list(c("Movement", "Rest")), paired = TRUE, size = 2.5) +
  theme_light(base_size = 8) +
  xlab("") +
  ylab("Number of episodes") +
  theme(strip.background = element_rect(fill = "white")) +
  theme(strip.text = element_text(colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)))

p4 <- counts %>%
  ggpaired(x = "Episode", y = "Count", id = "SID",
           line.color = "gray", line.size = 0.2, point.size = 0, color = "white") +
  facet_grid(~Cortex) +
  geom_boxplot(outlier.alpha = 0, fill = NA, linewidth = 0.25) +
  geom_point(alpha = 0.5, size = 1) +
  stat_compare_means(comparisons = list(c("Movement", "Rest")), paired = TRUE, size = 2.5) +
  theme_light(base_size = 8) +
  xlab("") +
  ylab("Number of episodes") +
  theme(strip.background = element_rect(fill = "white")) +
  theme(strip.text = element_text(colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)))

ggarrange(
  ggarrange(p1, p2, widths = c(0.3, 0.7), labels = letters[ 1:2 ], font.label = list(size = 10)),
  ggarrange(p3, p4, labels = letters[ 3:4 ], font.label = list(size = 10)),
  nrow = 2
)
```

**Figure 1.** Total number of detected movement and rest episodes in all samples **(a)**
and grouped by region **(b)**, layer **(c)**, and cortex **(d)**.


## Total episode length {.unnumbered .unlisted}

```{r, include = TRUE, fig.height = 5.4}
counts <- rbind(
  movement[ , list(Count = sum(Length), Episode = "Movement"), by = SID ],
  rest[ , list(Count = sum(Length), Episode = "Rest"), by = SID ]
) %>%
  merge(samples, by = "SID")

stopifnot(all(counts[ Episode == "Movement", SID ] %in% samples[ , SID ]))
stopifnot(all(counts[ Episode == "Rest", SID ] %in% samples[ , SID ]))

p1 <- counts %>%
  ggpaired(x = "Episode", y = "Count", id = "SID", ,
           line.color = "gray", line.size = 0.2, point.size = 0, color = "white") +
  geom_boxplot(outlier.alpha = 0, fill = NA, linewidth = 0.25) +
  geom_point(alpha = 0.5, size = 1) +
  stat_compare_means(comparisons = list(c("Movement", "Rest")), paired = TRUE, size = 2.5) +
  theme_light(base_size = 8) +
  xlab("") +
  ylab("Total episode length, s") +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)))

p2 <- counts %>%
  ggpaired(x = "Episode", y = "Count", id = "SID",
           line.color = "gray", line.size = 0.2, point.size = 0, color = "white") +
  facet_grid(~Region) +
  geom_boxplot(outlier.alpha = 0, fill = NA, linewidth = 0.25) +
  geom_point(alpha = 0.5, size = 1) +
  stat_compare_means(comparisons = list(c("Movement", "Rest")), paired = TRUE, size = 2.5) +
  theme_light(base_size = 8) +
  xlab("") +
  ylab("Total episode length, s") +
  theme(strip.background = element_rect(fill = "white")) +
  theme(strip.text = element_text(colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)))

p3 <- counts %>%
  ggpaired(x = "Episode", y = "Count", id = "SID",
           line.color = "gray", line.size = 0.2, point.size = 0, color = "white") +
  facet_grid(~Layer) +
  geom_boxplot(outlier.alpha = 0, fill = NA, linewidth = 0.25) +
  geom_point(alpha = 0.5, size = 1) +
  stat_compare_means(comparisons = list(c("Movement", "Rest")), paired = TRUE, size = 2.5) +
  theme_light(base_size = 8) +
  xlab("") +
  ylab("Total episode length, s") +
  theme(strip.background = element_rect(fill = "white")) +
  theme(strip.text = element_text(colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)))

p4 <- counts %>%
  ggpaired(x = "Episode", y = "Count", id = "SID",
           line.color = "gray", line.size = 0.2, point.size = 0, color = "white") +
  facet_grid(~Cortex) +
  geom_boxplot(outlier.alpha = 0, fill = NA, linewidth = 0.25) +
  geom_point(alpha = 0.5, size = 1) +
  stat_compare_means(comparisons = list(c("Movement", "Rest")), paired = TRUE, size = 2.5) +
  theme_light(base_size = 8) +
  xlab("") +
  ylab("Total episode length, s") +
  theme(strip.background = element_rect(fill = "white")) +
  theme(strip.text = element_text(colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)))

ggarrange(
  ggarrange(p1, p2, widths = c(0.3, 0.7), labels = letters[ 1:2 ], font.label = list(size = 10)),
  ggarrange(p3, p4, labels = letters[ 3:4 ], font.label = list(size = 10)),
  nrow = 2
)
```

**Figure 2.** Total amount of time spent in movement and rest in all samples **(a)**
and grouped by region **(b)**, layer **(c)**, and cortex **(d)**.


## Average episode length {.unnumbered .unlisted}

```{r, include = TRUE, warning = FALSE, fig.height = 5.4}
counts <- rbind(
  movement[ , list(Count = mean(Length), Episode = "Movement"), by = SID ],
  rest[ , list(Count = mean(Length), Episode = "Rest"), by = SID ]
) %>%
  merge(samples, by = "SID")

stopifnot(all(counts[ Episode == "Movement", SID ] %in% samples[ , SID ]))
stopifnot(all(counts[ Episode == "Rest", SID ] %in% samples[ , SID ]))

p1 <- counts %>%
  ggpaired(x = "Episode", y = "Count", id = "SID", ,
           line.color = "gray", line.size = 0.2, point.size = 0, color = "white") +
  geom_boxplot(outlier.alpha = 0, fill = NA, linewidth = 0.25) +
  geom_point(alpha = 0.5, size = 1) +
  stat_compare_means(comparisons = list(c("Movement", "Rest")), paired = TRUE, size = 2.5) +
  theme_light(base_size = 8) +
  xlab("") +
  ylab("Average episode length, s") +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)))

p2 <- counts %>%
  ggpaired(x = "Episode", y = "Count", id = "SID",
           line.color = "gray", line.size = 0.2, point.size = 0, color = "white") +
  facet_grid(~Region) +
  geom_boxplot(outlier.alpha = 0, fill = NA, linewidth = 0.25) +
  geom_point(alpha = 0.5, size = 1) +
  stat_compare_means(comparisons = list(c("Movement", "Rest")), paired = TRUE, size = 2.5) +
  theme_light(base_size = 8) +
  xlab("") +
  ylab("Average episode length, s") +
  theme(strip.background = element_rect(fill = "white")) +
  theme(strip.text = element_text(colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)))

p3 <- counts %>%
  ggpaired(x = "Episode", y = "Count", id = "SID",
           line.color = "gray", line.size = 0.2, point.size = 0, color = "white") +
  facet_grid(~Layer) +
  geom_boxplot(outlier.alpha = 0, fill = NA, linewidth = 0.25) +
  geom_point(alpha = 0.5, size = 1) +
  stat_compare_means(comparisons = list(c("Movement", "Rest")), paired = TRUE, size = 2.5) +
  theme_light(base_size = 8) +
  xlab("") +
  ylab("Average episode length, s") +
  theme(strip.background = element_rect(fill = "white")) +
  theme(strip.text = element_text(colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)))

p4 <- counts %>%
  ggpaired(x = "Episode", y = "Count", id = "SID",
           line.color = "gray", line.size = 0.2, point.size = 0, color = "white") +
  facet_grid(~Cortex) +
  geom_boxplot(outlier.alpha = 0, fill = NA, linewidth = 0.25) +
  geom_point(alpha = 0.5, size = 1) +
  stat_compare_means(comparisons = list(c("Movement", "Rest")), paired = TRUE, size = 2.5) +
  theme_light(base_size = 8) +
  xlab("") +
  ylab("Average episode length, s") +
  theme(strip.background = element_rect(fill = "white")) +
  theme(strip.text = element_text(colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)))

ggarrange(
  ggarrange(p1, p2, widths = c(0.3, 0.7), labels = letters[ 1:2 ], font.label = list(size = 10)),
  ggarrange(p3, p4, labels = letters[ 3:4 ], font.label = list(size = 10)),
  nrow = 2
)
```

**Figure 3.** Average amount of time spent in movement and rest in all samples **(a)**
and grouped by region **(b)**, layer **(c)**, and cortex **(d)**.


## Episode length distribution {.unlisted .unnumbered}

```{r, include = TRUE, warning = FALSE, fig.height = 5.6}
counts <- rbind(movement, rest) %>%
        .[ , Episode := ifelse(Movement == TRUE, "Movement", "Rest") ] %>%
        merge(samples, by = "SID")

stopifnot(all(counts[ Episode == "Movement", SID ] %in% samples[ , SID ]))
stopifnot(all(counts[ Episode == "Rest", SID ] %in% samples[ , SID ]))

p1 <- counts %>%
        ggplot(aes(x = log10(Length), color = Episode, fill = Episode)) +
        geom_density(alpha = 0.25) +
        theme_light(base_size = 8) +
        theme(legend.position = "top") +
        xlab("Episode length, log10") +
        ylab("Density")

p2 <- counts %>%
        ggplot(aes(x = log10(Length), color = Episode, fill = Episode)) +
        facet_grid(~Region) +
        geom_density(alpha = 0.25) +
        theme_light(base_size = 8) +
        theme(legend.position = "top") +
        theme(strip.background = element_rect(fill = "white")) +
        theme(strip.text = element_text(colour = "black")) +
        xlab("Episode length, log10") +
        ylab("Density")

p3 <- counts %>%
        ggplot(aes(x = log10(Length), color = Episode, fill = Episode)) +
        facet_grid(~Layer) +
        geom_density(alpha = 0.25) +
        theme_light(base_size = 8) +
        theme(legend.position = "top") +
        theme(strip.background = element_rect(fill = "white")) +
        theme(strip.text = element_text(colour = "black")) +
        xlab("Episode length, log10") +
        ylab("Density")

p4 <- counts %>%
        ggplot(aes(x = log10(Length), color = Episode, fill = Episode)) +
        facet_grid(~Cortex) +
        geom_density(alpha = 0.25) +
        theme_light(base_size = 8) +
        theme(legend.position = "top") +
        theme(strip.background = element_rect(fill = "white")) +
        theme(strip.text = element_text(colour = "black")) +
        xlab("Episode length, log10") +
        ylab("Density")

ggarrange(
        ggarrange(p1, p2, widths = c(0.3, 0.7), labels = letters[ 1:2 ], font.label = list(size = 10), common.legend = TRUE),
        ggarrange(p3, p4, labels = letters[ 3:4 ], font.label = list(size = 10), legend = FALSE),
        nrow = 2,
        heights = c(0.55, 0.45)
)
```

**Figure 4.** Episode length distribution in movement and rest in all samples **(a)**
and grouped by region **(b)**, layer **(c)**, and cortex **(d)**.
